<?php
add_theme_support('menus');

// Enqueue styles for the child theme
add_action( 'wp_enqueue_scripts', 'intermedics_child_enqueue_styles' );
function intermedics_child_enqueue_styles() {
    wp_enqueue_style( 'parent-style', get_template_directory_uri() . '/style.css' );
    wp_enqueue_style( 'child-style', get_stylesheet_uri(), array('parent-style'), wp_get_theme()->get('Version') );
}

function intermedics_enqueue_bootstrap() {
    wp_enqueue_style(
        'bootstrap-css',
        'https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css',
        [],
        '5.3.3'
    );
}
add_action('wp_enqueue_scripts', 'intermedics_enqueue_bootstrap');

// Remove <p> and <br/> from Contact Form 7
add_filter('wpcf7_autop_or_not', '__return_false');

// Get all services
function intermedics_services_grid($atts) {
    // Define default shortcode attributes
    $atts = shortcode_atts([
        'posts_per_page' => 3,
    ], $atts);

    // Create custom query
    $query = new WP_Query([
        'post_type'      => 'services',
        'posts_per_page' => intval($atts['posts_per_page']),
        'post_status'    => 'publish',
    ]);

    ob_start();

    if ($query->have_posts()) { 
        while ($query->have_posts()) {
            $query->the_post(); 
			$section_title   = get_field('section_title');
			$feature_list      = get_field('feature_list');
			?>
            <section class="section-services">
                <div class="container-fluid">
                    <div class="row align-items-center g-4">
                        <!-- Text Column -->
                        <div class="col-lg-6">
                            <div class="badge-services"><?php echo !empty($section_title) ? esc_html($section_title) : 'Our Services'; ?></div>
                            <h2 class="fw-bold mb-3 services-title"><?php the_title(); ?></h2>
                            <div class="mb-5 text-muted services-desc">
                                <?php echo wp_trim_words(get_the_content()); ?>
								<?php echo !empty($feature_list) ? '<div class="featurelist mt-3">'.$feature_list.'</div>' : ''; ?>
							</div>
                            <a href="<?php the_permalink(); ?>" class="custom-know-more-btn">
                                Know More <i class="icon icon-arrow-right"></i>
                            </a>
                        </div>
                        <!-- Image Column -->
                        <div class="col-lg-6 text-center">
                            <?php if (has_post_thumbnail()) : ?>
                                <img src="<?php the_post_thumbnail_url('full'); ?>" 
                                     class="img-fluid" 
                                     alt="<?php the_title_attribute(); ?>" loading="lazy">
                            <?php endif; ?>
                        </div>
                    </div>
                </div>
            </section>

        <?php }
    } else {
        echo '<p>No services found.</p>';
    }

    wp_reset_postdata();

    return ob_get_clean();
}
add_shortcode('services_grid', 'intermedics_services_grid');

function partners_section_shortcode($atts) {
    ob_start();
    ?>
    <section class="section-partners">
      <div class="container-fluid">
        <?php
        $partners_query = new WP_Query([
            'post_type'      => 'partners',
            'posts_per_page' => -1,
            'post_status'    => 'publish',
	    'order'    => 'DESC',
        ]);

        if ($partners_query->have_posts()):
        ?>
        <div class="row">
          <?php
          $i = 0;
          while ($partners_query->have_posts()):
              $partners_query->the_post();
              $i++;
              $logo_url = get_the_post_thumbnail_url(get_the_ID(), 'full');
              $description = get_the_excerpt();

              if ($i === 1): 
          ?>
          <!-- First post big column -->
          <div class="col-lg-6 d-flex align-items-center">
            <div class="rounded partner-card-first text-center text-lg-start">
				<div class="img-section">
              <?php if($logo_url): ?>
                <img src="<?php echo esc_url($logo_url); ?>" alt="<?php the_title_attribute(); ?>" class="img-fluid mb-3" loading="lazy">
              <?php endif; ?>
			  </div>
              <p class="partner-card-desc mt-4 mb-5"><?php echo esc_html($description); ?></p>
			  <a href="<?php echo get_post_type_archive_link('partners'); ?>" class="custom-know-more-btn partner">View All Partners <i class="icon icon-arrow-right"></i></a>
            </div>
          </div>

          <!-- Open second column -->
          <div class="col-lg-6 d-flex align-items-center">
            <div class="row g-5">
          <?php
              else:
          ?>
              <div class="col-6">
                <div class="rounded partner-card d-flex align-items-center justify-content-center">
                  <?php if($logo_url): ?>
                    <img src="<?php echo esc_url($logo_url); ?>" alt="<?php the_title_attribute(); ?>" class="img-fluid" loading="lazy">
                  <?php endif; ?>
                </div>
              </div>
          <?php
              endif;
          endwhile;
          ?>
            </div> <!-- .row inside second col -->
          </div> <!-- .col-lg-6 -->
        </div> <!-- .row -->
        <?php
        wp_reset_postdata();
        else:
        ?>
          <p class="text-white">No partners found.</p>
        <?php endif; ?>
      </div>
    </section>
    <?php
    return ob_get_clean();
}
add_shortcode('partners_section', 'partners_section_shortcode');

function news_event_section_shortcode() {
    ob_start();
    ?>

    <div class="container-fluid mt-4">
        <div class="row g-5 d-flex">

            <!-- LEFT COLUMN -->
            <div class="col-lg-4 align-items-center">
                <?php
                // LEFT COLUMN Query: Upcoming Event
                $left_query = new WP_Query(array(
                    'post_type'      => 'news_event',
                    'posts_per_page' => 1,
                    'post_status'    => 'publish',
                    'tax_query'      => array(
                        array(
                            'taxonomy' => 'newsevent',
                            'field'    => 'slug',
                            'terms'    => array('upcoming-event'), // your category slug here
                        ),
                    ),
                ));

                if ( $left_query->have_posts() ) :
                    while ( $left_query->have_posts() ) : $left_query->the_post();
						$section_title = get_field('section_title');
                        ?>

                        <div class="p-4 rounded shadow w-100 bg-upevent">
                            <span class="badge mt-4 mb-4 text-uppercase small badge-title">
							<?php echo !empty($section_title) ? $section_title : ''; ?>
							</span>

                            <?php if ( $event_date = get_field('event_date') ) : ?>
                                <div class="display-6 mb-4 eventdate">
                                    <?php echo date('d', strtotime($event_date)); ?> 
                                    <small class="d-block fs-6"><?php echo date('M', strtotime($event_date)); ?></small>
                                </div>
                            <?php endif; ?>

                            <h4 class="fw-bold mb-2 eventtitle"><?php the_title(); ?></h4>
                            <div class="mb-4 eventcontent"><?php the_excerpt(); ?></div>
							<div class="d-flex"><a href="<?php the_permalink(); ?>" class="btn btn-primary ms-auto eventbtn">Read More <i class="icon icon-arrow-right"></i></a></div>
                        </div>

                        <?php
                    endwhile;
                    wp_reset_postdata();
                endif;
                ?>
            </div>

            <!-- RIGHT COLUMN -->
            <div class="col-lg-8 align-items-center">
                <div class="row g-4 newsrow">

                    <?php
                    // RIGHT COLUMN Query: All except Upcoming Event
                    $right_query = new WP_Query(array(
                        'post_type'      => 'news_event',
                        'posts_per_page' => 3, // as needed
                        'post_status'    => 'publish',
                        'tax_query'      => array(
                            array(
                                'taxonomy' => 'newsevent',
                                'field'    => 'slug',
                                'terms'    => array('upcoming-event'),
                                'operator' => 'NOT IN',
                            ),
                        ),
                    ));

                    if ( $right_query->have_posts() ) :
                        while ( $right_query->have_posts() ) : $right_query->the_post();
							$section_title = get_field('section_title');
							$event_date = get_field('event_date');
                                                        $post_index = $right_query->current_post;
                            ?>

                            <div class="col-12">
                                <div class="d-flex pb-4 news-section">

                                    <?php if (has_post_thumbnail()): ?>
                                        <div class="me-5 flex-shrink-0" style="width: 148px; height: 136px;">
                                            <?php the_post_thumbnail('thumbnail', ['class' => 'img-fluid rounded', 'style' => 'object-fit:cover; width:100%; height:100%;']); ?>
                                        </div>
                                    <?php endif; ?>

                                    <div class="flex-grow-1">
                                        <div class="mb-3">
                                            <span class="badge text-uppercase small badge-title">
											<?php 
											if(!empty($event_date) && $section_title) {
												echo $section_title .' | ' .date('j F,Y', strtotime($event_date));;
											}else{
												echo !empty($section_title) ? $section_title : '';
											}
											?>  
                                            </span>
                                        </div>
                                        <h6 class="mb-3 fw-bold h-title">
                                            <a href="<?php the_permalink(); ?>" class="text-decoration-none text-dark news-title">
                                                <?php the_title(); ?>
                                            </a>
                                        </h6>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <a href="<?php the_permalink(); ?>" class="btn btn-outline-primary btn-sm rounded-circle <?php echo ($post_index == 1) ? 'newsbtn2' : 'newsbtn'; ?>">
                                        <?php echo ($post_index == 1) ? 'Read More' : ''; ?>
										 <i class="icon icon-arrow-right"></i>
                                        </a>
                                    </div>

                                </div>
                            </div>

                            <?php
                        endwhile;
                        wp_reset_postdata();
                    endif;
                    ?>

                </div>
            </div>

        </div>
    </div>

    <?php
    return ob_get_clean();
}
add_shortcode('news_event_section', 'news_event_section_shortcode');

/* Testimonials */
function display_testimonial_section($atts) {
    ob_start();

    // Query latest testimonial
    $args = array(
        'post_type' => 'testimonials',
        'posts_per_page' => 1,
    );
    $query = new WP_Query($args);

    if ($query->have_posts()) :
        while ($query->have_posts()) : $query->the_post();
            // Get custom fields
            $name = get_field('name_of_client');
            $designation = get_field('designation');
            ?>
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-12">
                        <div class="badge-title-testimonial mb-4">TESTIMONIALS</div>
                        <h2 class="testimonial-title"><?php the_title(); ?></h2>
                        <div class="testimonial-content"><?php the_content(); ?></div>
                        <h6 class="testimonial-name m-0"><?php echo esc_html($name); ?></h6>
                        <small class="text-muted testimonial-designation"><?php echo esc_html($designation); ?></small>
                    </div>
                </div>
            </div>
            <?php
        endwhile;
        wp_reset_postdata();
    else :
        echo '<p>No testimonials found.</p>';
    endif;

    return ob_get_clean();
}
add_shortcode('testimonial_section', 'display_testimonial_section');

